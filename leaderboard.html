<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enfild Fantazi | Leaderboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 800px; text-align: center; }
        .home-btn { 
            position: absolute; top: 20px; left: 20px; 
            padding: 10px 15px; background: #e24a4a; color: white; 
            text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 0.9rem;
        }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: #f8fafc; color: #64748b; padding: 15px; border-bottom: 2px solid #edf2f7; text-transform: uppercase; font-size: 0.85rem; }
        td { padding: 15px; border-bottom: 1px solid #edf2f7; color: #2d3748; }
        tr:hover { background-color: #f1f5f9; }
        .points { font-weight: bold; color: #2ecc71; }

        /* Make the entire row look interactive */
        #leaderboard-body tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #leaderboard-body tr:hover {
            background-color: #edf2f7; /* Light blue/gray highlight */
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="home-btn">Nazad</a>
        <h1>Leaderboard</h1>
        <table>
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Username</th>
                    <th>Ime</th>
                    <th>Poeni</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                <tr><td colspan="4">Loading rankings...</td></tr>
            </tbody>
        </table>
    </div>

    <script>
        const SUPABASE_URL = 'https://kouvepburiaqlgmgdwla.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_To3N8ID0x-VKZjlgGon-1A_6wpFLmm4';
        const mySupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadLeaderboard() {
            // 1. Fetch all necessary data
            const { data: teams } = await mySupabase.from('user_teams').select('*');
            const { data: players } = await mySupabase.from('players').select('id, name');
            const { data: pastTeams } = await mySupabase.from('past_teams').select('*');
            const { data: allScores } = await mySupabase.from('player_scores').select('*');
            
            const tbody = document.getElementById('leaderboard-body');
            tbody.innerHTML = '';

            if (!teams) return;

            // 2. Map users to their total points
            const leaderboardData = teams.map(userRow => {
                let totalPoints = 0;

                // Filter all historical entries for THIS user
                const userHistory = pastTeams.filter(pt => pt.user_id === userRow.user_id);

                userHistory.forEach(historyRow => {
                    const round = historyRow.round_number;
                    const teamIds = historyRow.player_ids; // e.g., [1, 5, 12]

                    // Find points for these players in THIS specific round
                    teamIds.forEach(pId => {
                        const scoreEntry = allScores.find(s => s.player_id == pId && s.round_number == round);
                        if (scoreEntry) {
                            totalPoints += scoreEntry.points;
                        }
                    });
                });

                // Determine names for display
                let realName = "Unknown";
                if (userRow.representative_player_id) {
                    const p = players.find(player => player.id === userRow.representative_player_id);
                    realName = p ? p.name : "Missing Player";
                } else {
                    realName = userRow.temp_name || "Pending...";
                }

                return {
                    ...userRow,
                    realName: realName,
                    totalPoints: totalPoints
                };
            });

            // 3. Sort by points (Highest first)
            leaderboardData.sort((a, b) => b.totalPoints - a.totalPoints);

            // 4. Render the rows
            leaderboardData.forEach((user, index) => {
                // Only show if they have a team
                if (!user.player_ids || user.player_ids.length === 0) return;

                const row = document.createElement('tr');
                row.onclick = () => {
                    window.location.href = `timovi.html?id=${user.user_id}&name=${encodeURIComponent(user.username)}`;
                };

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${user.username || 'user'}</strong></td>
                    <td>${user.realName}</td>
                    <td class="points">${user.totalPoints.toFixed(1)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        loadLeaderboard();
    </script>
</body>
</html>