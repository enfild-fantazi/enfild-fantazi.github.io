<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enfild Fantazi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Your existing styles + Home Button style */
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        
        .home-btn { 
            position: absolute; top: 20px; left: 20px; 
            padding: 10px 15px; background: #4a90e2; color: white; 
            text-decoration: none; border-radius: 8px; font-weight: bold;
        }

        .sprite-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 30px; }
        .player-card { background: white; padding: 15px; border-radius: 10px; width: 160px; position: relative; border: 2px solid #ddd; }
        .remove-btn { position: absolute; top: -10px; right: -10px; background: #ff4d4d; color: white; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; border: none; font-weight: bold; }
        .add-btn { padding: 20px; border: 2px dashed #bbb; border-radius: 10px; cursor: pointer; align-self: center; font-size: 2rem; color: #888; }
        
        #budget-display { font-size: 1.5rem; margin: 20px; font-weight: bold; background: white; display: inline-block; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .save-btn { margin-top: 40px; padding: 15px 40px; background: #3ecf8e; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        .save-btn:hover { background: #36b37a; }
        
        select { width: 100%; margin-top: 10px; padding: 5px; }
        .cost-tag { color: #666; font-size: 0.9rem; margin-top: 8px; }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">üè† Home</a>

    <h1>Moj tim</h1>
    
    <div id="budget-display">
        Remaining Credits: <span id="current-credits">0.0</span> / <span id="total-credits">0.0</span>
    </div>

    <div class="sprite-container" id="team-slots"></div>

    <button class="save-btn" onclick="saveTeam()">Save Team</button>

    <script>
        const SUPABASE_URL = 'https://kouvepburiaqlgmgdwla.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_To3N8ID0x-VKZjlgGon-1A_6wpFLmm4';
        const mySupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allPlayers = [];
        let userTeam = []; 
        let totalCredits = 70.0;
        let repPlayerId = null;

        async function init() {
            const { data: { session } } = await mySupabase.auth.getSession();
            if (!session) { window.location.href = "login.html"; return; }

            // 2. Sort players by cost (Reverse: Highest to Lowest)
            const { data: players } = await mySupabase
                .from('players')
                .select('*')
                .order('cost', { ascending: false }); // Database handles the sorting
            
            allPlayers = players;

            const { data: userData } = await mySupabase
                .from('user_teams')
                .select('*')
                .eq('user_id', session.user.id)
                .single();

            if (userData) {
                totalCredits = userData.total_credits;
                repPlayerId = userData.representative_player_id;
                if (userData.player_ids) {
                    userTeam = userData.player_ids.map(id => allPlayers.find(p => p.id === id)).filter(p => p);
                }
            }

            if (userTeam.length === 0) userTeam = [null, null, null];
            renderTeam();
        }

        function renderTeam() {
            const container = document.getElementById('team-slots');
            container.innerHTML = '';
            let spent = 0;

            userTeam.forEach((selectedPlayer, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';

                if (userTeam.length > 3) {
                    const xBtn = document.createElement('button');
                    xBtn.innerText = '√ó';
                    xBtn.className = 'remove-btn';
                    xBtn.onclick = () => { userTeam.splice(index, 1); renderTeam(); };
                    card.appendChild(xBtn);
                }

                const select = document.createElement('select');
                select.innerHTML = `<option value="">-- Select Player --</option>`;
                
                allPlayers.forEach(p => {
                    const isTaken = userTeam.some((ut, i) => ut && ut.id === p.id && i !== index);
                    const isSelf = p.id === repPlayerId;

                    if (!isTaken && !isSelf) {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text = `${p.name} (${p.cost.toFixed(1)})`; // Show 1 decimal
                        if (selectedPlayer && selectedPlayer.id === p.id) opt.selected = true;
                        select.appendChild(opt);
                    }
                });

                select.onchange = (e) => {
                    const p = allPlayers.find(pl => pl.id == e.target.value);
                    userTeam[index] = p || null;
                    renderTeam();
                };

                card.appendChild(select);

                if (selectedPlayer) {
                    spent += selectedPlayer.cost;
                    const info = document.createElement('div');
                    info.className = 'cost-tag';
                    info.innerHTML = `<strong>${selectedPlayer.name}</strong><br>Cost: ${selectedPlayer.cost.toFixed(1)}`;
                    card.appendChild(info);
                }
                container.appendChild(card);
            });

            if (userTeam.length < 5) {
                const addBtn = document.createElement('div');
                addBtn.className = 'add-btn';
                addBtn.innerText = '+';
                addBtn.onclick = () => { userTeam.push(null); renderTeam(); };
                container.appendChild(addBtn);
            }

            // 3. Math Fix: Using .toFixed(1) to avoid 10.39999999
            const remaining = (totalCredits - spent).toFixed(1);
            document.getElementById('total-credits').innerText = totalCredits.toFixed(1);
            document.getElementById('current-credits').innerText = remaining;
            document.getElementById('current-credits').style.color = (remaining < 0) ? '#ff4d4d' : '#333';
        }

        async function saveTeam() {
            const spent = userTeam.reduce((sum, p) => sum + (p ? p.cost : 0), 0);
            const playerIds = userTeam.map(p => p ? p.id : null).filter(id => id !== null);

            if (playerIds.length < 3) return alert("You need at least 3 players!");
            if (spent > totalCredits + 0.01) return alert("You are over budget!"); // +0.01 buffer for float math
            
            const { data: { session } } = await mySupabase.auth.getSession();
            
            // 4. THE FIX: Using .upsert() replaces the old row if user_id matches
            // IMPORTANT: Your user_teams table must have 'user_id' set as a PRIMARY KEY or UNIQUE constraint
            const { error } = await mySupabase
                .from('user_teams')
                .upsert({
                    user_id: session.user.id,
                    player_ids: playerIds,
                    total_credits: totalCredits, // Keeps their current credit limit
                    representative_player_id: repPlayerId
                }, { onConflict: 'user_id' }); // Ensures it overwrites based on the user ID

            if (error) alert("Team save failed: " + error.message);
            else alert("Team successfully saved!");
        }

        init();
    </script>
</body>
</html>