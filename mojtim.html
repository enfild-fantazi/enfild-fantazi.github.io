<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Enfild Fantazi</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        .sprite-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 30px; }
        .player-card { background: white; padding: 15px; border-radius: 10px; width: 150px; position: relative; border: 2px solid #ddd; }
        .remove-btn { position: absolute; top: -10px; right: -10px; background: red; color: white; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; border: none; }
        .add-btn { padding: 20px; border: 2px dashed #bbb; border-radius: 10px; cursor: pointer; align-self: center; font-size: 2rem; }
        #budget-display { font-size: 1.5rem; margin: 20px; font-weight: bold; }
        .save-btn { margin-top: 40px; padding: 15px 30px; background: #3ecf8e; color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        select { width: 100%; margin-top: 10px; }
        .cost-tag { color: #666; font-size: 0.9rem; }
    </style>
</head>
<body>

    <h1>Moj tim</h1>
    <div id="budget-display">Remaining Credits: <span id="current-credits">0</span> / <span id="total-credits">0</span></div>

    <div class="sprite-container" id="team-slots">
        </div>

    <button class="save-btn" onclick="saveTeam()">Save Team</button>

    <script>
        const SUPABASE_URL = 'https://kouvepburiaqlgmgdwla.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_To3N8ID0x-VKZjlgGon-1A_6wpFLmm4';
        const mySupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let allPlayers = [];
        let userTeam = []; // Array of player objects
        let totalCredits = 70;
        let repPlayerId = null;

        async function init() {
            // 1. Get current user
            const { data: { session } } = await mySupabase.auth.getSession();
            if (!session) { window.location.href = "login.html"; return; }

            // 2. Load all players from DB
            const { data: players } = await mySupabase.from('players').select('*');
            allPlayers = players;

            // 3. Load user data (Team, Credits, Rep Player)
            const { data: userData } = await mySupabase.from('user_teams').select('*').eq('user_id', session.user.id).single();

            if (userData) {
                totalCredits = userData.total_credits;
                repPlayerId = userData.representative_player_id;
                // If they have a team, map IDs back to player objects
                if (userData.player_ids) {
                    userTeam = userData.player_ids.map(id => allPlayers.find(p => p.id === id)).filter(p => p);
                }
            }

            // If new user, start with 3 empty slots
            if (userTeam.length === 0) {
                userTeam = [null, null, null];
            }

            renderTeam();
        }

        function renderTeam() {
            const container = document.getElementById('team-slots');
            container.innerHTML = '';
            let spent = 0;

            userTeam.forEach((selectedPlayer, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';

                // "X" button for slots 4 and 5 (or any if total > 3)
                if (userTeam.length > 3) {
                    const xBtn = document.createElement('button');
                    xBtn.innerText = 'Ã—';
                    xBtn.className = 'remove-btn';
                    xBtn.onclick = () => { userTeam.splice(index, 1); renderTeam(); };
                    card.appendChild(xBtn);
                }

                const select = document.createElement('select');
                select.innerHTML = `<option value="">-- Select Player --</option>`;
                
                // Filter: No self-selection, no duplicates
                allPlayers.forEach(p => {
                    const isTaken = userTeam.some((ut, i) => ut && ut.id === p.id && i !== index);
                    const isSelf = p.id === repPlayerId;

                    if (!isTaken && !isSelf) {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.text = `${p.name} (${p.cost})`;
                        if (selectedPlayer && selectedPlayer.id === p.id) opt.selected = true;
                        select.appendChild(opt);
                    }
                });

                select.onchange = (e) => {
                    const p = allPlayers.find(pl => pl.id == e.target.value);
                    userTeam[index] = p || null;
                    renderTeam();
                };

                card.appendChild(select);

                if (selectedPlayer) {
                    spent += selectedPlayer.cost;
                    const info = document.createElement('div');
                    info.className = 'cost-tag';
                    info.innerHTML = `<br><strong>${selectedPlayer.name}</strong><br>Cost: ${selectedPlayer.cost}`;
                    card.appendChild(info);
                }

                container.appendChild(card);
            });

            // "+" button for slots
            if (userTeam.length < 5) {
                const addBtn = document.createElement('div');
                addBtn.className = 'add-btn';
                addBtn.innerText = '+';
                addBtn.onclick = () => { userTeam.push(null); renderTeam(); };
                container.appendChild(addBtn);
            }

            // Update Budget
            document.getElementById('total-credits').innerText = totalCredits;
            document.getElementById('current-credits').innerText = totalCredits - spent;
            document.getElementById('current-credits').style.color = (totalCredits - spent < 0) ? 'red' : 'black';
        }

        async function saveTeam() {
            const spent = userTeam.reduce((sum, p) => sum + (p ? p.cost : 0), 0);
            const playerIds = userTeam.map(p => p ? p.id : null).filter(id => id !== null);

            // VALIDATION
            if (playerIds.length < 3) return alert("Min 3 players required!");
            if (spent > totalCredits) return alert("Over budget!");
            if (new Set(playerIds).size !== playerIds.length) return alert("No duplicate players!");

            const { data: { session } } = await mySupabase.auth.getSession();
            const { error } = await mySupabase.from('user_teams').upsert({
                user_id: session.user.id,
                player_ids: playerIds
            });

            if (error) alert("Save failed: " + error.message);
            else alert("Team successfully saved!");
        }

        init();
    </script>
</body>
</html>