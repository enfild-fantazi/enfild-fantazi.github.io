<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enfild Fantazi | Moj tim</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; padding: 20px; text-align: center; color: #333; }
        
        /* Navigation */
        .home-btn { 
            position: absolute; top: 20px; left: 20px; 
            padding: 10px 15px; background: #e24a4a; color: white; 
            text-decoration: none; border-radius: 8px; font-weight: bold; font-size: 0.9rem;
        }

        /* Budget & Timer Header */
        header { margin-top: 40px; }
        #deadline-timer { color: #e74c3c; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; }
        #budget-display { 
            font-size: 1.5rem; margin: 20px; font-weight: bold; 
            background: white; display: inline-block; padding: 15px 30px; 
            border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
        }

        /* Team Slots */
        .sprite-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin-top: 30px; min-height: 250px; }
        .player-card { 
            background: white; padding: 20px; border-radius: 15px; 
            width: 170px; position: relative; border: 2px solid #eee;
            transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .remove-btn { 
            position: absolute; top: -10px; right: -10px; 
            background: #ff4d4d; color: white; border-radius: 50%; 
            width: 28px; height: 28px; cursor: pointer; border: none; font-weight: bold; 
        }
        .add-btn { 
            width: 170px; height: 210px; border: 3px dashed #cbd5e0; 
            border-radius: 15px; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; font-size: 3rem; color: #a0aec0;
        }
        .add-btn:hover { border-color: #4a90e2; color: #4a90e2; }

        /* Inputs */
        select { width: 100%; margin-top: 15px; padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .cost-tag { margin-top: 15px; font-size: 0.95rem; line-height: 1.4; }
        .cost-tag strong { color: #2d3748; display: block; margin-bottom: 4px; }

        /* Save Button */
        .save-btn { 
            margin-top: 50px; padding: 18px 50px; background: #3ecf8e; 
            color: white; border: none; border-radius: 10px; 
            font-size: 1.2rem; cursor: pointer; font-weight: bold; 
            transition: background 0.2s; box-shadow: 0 4px 14px rgba(62, 207, 142, 0.4);
        }
        .save-btn:disabled { background: #cbd5e0 !important; cursor: not-allowed; box-shadow: none; }
    </style>
</head>
<body>

    <a href="index.html" class="home-btn">Nazad</a>

    <header>
        <h1>Moj tim</h1>
        <div id="deadline-timer">Checking deadline...</div>
        <div id="budget-display">
            Remaining: <span id="current-credits">0.0</span> / <span id="total-credits">0.0</span>
        </div>
    </header>

    <div class="sprite-container" id="team-slots"></div>

    <button class="save-btn" id="main-save-btn" onclick="saveTeam()">Save Team</button>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://kouvepburiaqlgmgdwla.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_To3N8ID0x-VKZjlgGon-1A_6wpFLmm4';
        const mySupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- STATE ---
        let allPlayers = [];
        let userTeam = []; 
        let totalCredits = 70.0; // This will be dynamic
        let repPlayerId = null;
        let DEADLINE = null;
        let manualRound = 1;

        // Updated to Banker's Rounding (Round to Even)
        function calculateGain(points, cost) {
            const raw = (points - cost) * 0.1;
            
            // Internal Banker's Rounding logic
            const roundToEven = (num) => {
                const d = 1; // 1 decimal place
                const m = Math.pow(10, d);
                const n = +(num * m).toFixed(8); // Handle floating point precision
                const i = Math.floor(n), f = n - i;
                const e = 1e-8; // tiny epsilon for precision
                
                const r = (f > 0.5 - e && f < 0.5 + e) ?
                        ((i % 2 === 0) ? i : i + 1) : Math.round(n);
                return r / m;
            };

            let finalGain = roundToEven(raw);

            // Floor logic: Cost cannot go below 4.0
            if (finalGain < 0 && (cost + finalGain) < 4.0) {
                finalGain = -(cost - 4.0);
            }
            
            return finalGain;
        }

        // --- INITIALIZATION ---
        async function init() {
            const { data: { session } } = await mySupabase.auth.getSession();
            if (!session) { window.location.href = "login.html"; return; }

            // 1. Fetch Manual Round Number & Deadline from 'settings'
            const { data: settingsData } = await mySupabase.from('settings').select('*');
            
            const roundSetting = settingsData.find(s => s.key === 'current_round');
            manualRound = roundSetting ? parseInt(roundSetting.value) : 1;

            const deadlineSetting = settingsData.find(s => s.key === 'draft_deadline');
            if (deadlineSetting) DEADLINE = new Date(deadlineSetting.value);

            // 2. Fetch all raw data for calculations
            const { data: rawPlayers } = await mySupabase.from('players').select('*');
            const { data: allScores } = await mySupabase.from('player_scores').select('*').lt('round_number', manualRound);
            const { data: userHistory } = await mySupabase.from('past_teams').select('*').eq('user_id', session.user.id).lt('round_number', manualRound);
            const { data: userData } = await mySupabase.from('user_teams').select('*').eq('user_id', session.user.id).single();

            // 3. Calculate DYNAMIC Player Costs
            allPlayers = rawPlayers.map(p => {
                let runningCost = p.cost;
                const pScores = allScores.filter(s => s.player_id === p.id).sort((a,b) => a.round_number - b.round_number);
                pScores.forEach(s => {
                    runningCost += calculateGain(s.points, runningCost);
                });
                return { ...p, cost: runningCost };
            }).sort((a, b) => b.cost - a.cost);

            // 4. Calculate DYNAMIC User Budget
            let totalGainFromHistory = 0;
            userHistory.forEach(round => {
                round.player_ids.forEach((pId, index) => {
                    const costAtTime = round.player_costs_at_time[index];
                    const score = allScores.find(s => s.player_id === pId && s.round_number === round.round_number);
                    if (score) {
                        totalGainFromHistory += calculateGain(score.points, costAtTime);
                    }
                });
            });

            if (userData) {
                // Budget is original credits (usually 70 or 100) + gains from every previous round
                totalCredits = (userData.total_credits || 70.0) + totalGainFromHistory;
                repPlayerId = userData.representative_player_id;
                if (userData.player_ids) {
                    userTeam = userData.player_ids.map(id => allPlayers.find(p => p.id === id)).filter(p => p);
                }
            }

            if (userTeam.length === 0) userTeam = [null, null, null];

            renderTeam();
            startTimer();
        }

        // --- LOGIC ---
        function isLocked() {
            if (!DEADLINE) return false;
            return new Date() > DEADLINE;
        }

        function renderTeam() {
            const locked = isLocked();
            const container = document.getElementById('team-slots');
            const saveBtn = document.getElementById('main-save-btn');
            container.innerHTML = '';
            let spent = 0;

            userTeam.forEach((selectedPlayer, index) => {
                const card = document.createElement('div');
                card.className = 'player-card';

                if (userTeam.length > 3 && !locked) {
                    const xBtn = document.createElement('button');
                    xBtn.innerText = 'Ã—';
                    xBtn.className = 'remove-btn';
                    xBtn.onclick = () => { userTeam.splice(index, 1); renderTeam(); };
                    card.appendChild(xBtn);
                }

                const select = document.createElement('select');
                select.disabled = locked;
                select.innerHTML = `<option value="">-- Select Player --</option>`;
                
                allPlayers.forEach(p => {
                    const isTaken = userTeam.some((ut, i) => ut && ut.id === p.id && i !== index);
                    const isSelf = p.id === repPlayerId;

                    if (!isTaken && !isSelf) {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        let statusTag = p.is_playing ? "" : "[NE IGRA] ";
                        opt.text = `${statusTag}${p.name} (${p.cost.toFixed(1)})`;
                        if (selectedPlayer && selectedPlayer.id === p.id) opt.selected = true;
                        select.appendChild(opt);
                    }
                });

                select.onchange = (e) => {  
                    const p = allPlayers.find(pl => pl.id == e.target.value);
                    userTeam[index] = p || null;
                    renderTeam();
                };

                card.appendChild(select);

                if (selectedPlayer) {
                    spent += selectedPlayer.cost;
                    const info = document.createElement('div');
                    info.className = 'cost-tag';
                    const nameStyle = selectedPlayer.is_playing ? "" : "color: #ff4d4d;";
                    const statusText = selectedPlayer.is_playing ? "" : "<small>[NE IGRA]</small> ";

                    info.innerHTML = `
                        <strong style="${nameStyle}">${statusText}${selectedPlayer.name}</strong>
                        Cost: ${selectedPlayer.cost.toFixed(1)}
                    `;
                    card.appendChild(info);
                }
                container.appendChild(card);
            });

            if (userTeam.length < 5 && !locked) {
                const addBtn = document.createElement('div');
                addBtn.className = 'add-btn';
                addBtn.innerText = '+';
                addBtn.onclick = () => { userTeam.push(null); renderTeam(); };
                container.appendChild(addBtn);
            }

            if (locked) {
                saveBtn.disabled = true;
                saveBtn.innerText = "Editovanje zatvoreno";
            }

            const remaining = (totalCredits - spent).toFixed(1);
            document.getElementById('total-credits').innerText = totalCredits.toFixed(1);
            const creditSpan = document.getElementById('current-credits');
            creditSpan.innerText = remaining;
            creditSpan.style.color = (parseFloat(remaining) < -0.01) ? '#e74c3c' : '#2ecc71';
        }

        function startTimer() {
            function update() {
                const timerDiv = document.getElementById('deadline-timer');
                if (!DEADLINE) { timerDiv.innerText = ""; return; }
                const now = new Date();
                const diff = DEADLINE - now;

                if (diff <= 0) {
                    timerDiv.innerText = "EDITOVANJE TIMOVA ZATVORENO";
                    if (!saveBtnDisabledState) renderTeam(); 
                } else {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const secs = Math.floor((diff % (1000 * 60)) / 1000);
                    timerDiv.innerText = `Deadline in: ${hours}h ${mins}m ${secs}s`;
                }
            }
            setInterval(update, 1000);
            update();
        }

        async function saveTeam() {
            if (isLocked()) return alert("Deadline passed!");

            const spent = userTeam.reduce((sum, p) => sum + (p ? p.cost : 0), 0);
            const playerIds = userTeam.map(p => p ? p.id : null).filter(id => id !== null);

            // RE-ADDED VALIDATIONS
            if (playerIds.length < 3) return alert("Select at least 3 players!");
            if (spent > totalCredits + 0.05) {
                return alert(`Over budget!`);
            }

            const { data: { session } } = await mySupabase.auth.getSession();
            
            const { error } = await mySupabase
                .from('user_teams')
                .upsert({
                    user_id: session.user.id,
                    player_ids: playerIds
                }, { onConflict: 'user_id' });

            if (error) alert("Error: " + error.message);
            else alert("Team successfully saved!");
        }

        init();
    </script>
</body>
</html>