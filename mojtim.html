<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enfild Fantazi | Moj tim</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; text-align: center; }
        
        /* Header & Budget UI */
        .stats-bar { 
            background: #2d3748; color: white; padding: 20px; 
            border-radius: 15px; margin-bottom: 20px; position: sticky; top: 10px; z-index: 100;
            display: flex; justify-content: space-around; align-items: center;
        }
        .budget-val { font-size: 1.5rem; font-weight: 800; color: #2ecc71; }

        /* Grid */
        .player-grid { 
            display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 20px; margin-top: 20px; 
        }
        .player-card { 
            background: white; border-radius: 15px; padding: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 2px solid transparent;
            transition: 0.2s; cursor: pointer;
        }
        .player-card.selected { border-color: #4a90e2; background: #ebf4ff; }
        .player-name { font-weight: bold; font-size: 1.1rem; display: block; margin-bottom: 10px; }
        .price-tag { color: #4a5568; font-weight: 600; }

        .btn-save { 
            margin-top: 30px; padding: 15px 40px; background: #4a90e2; 
            color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="stats-bar">
        <div>
            <span style="font-size: 0.8rem; color: #a0aec0; display: block;">AVAILABLE CREDITS</span>
            <span id="credit-display" class="budget-val">Loading...</span>
        </div>
        <button class="btn-save" onclick="saveTeam()">Save Team</button>
    </div>

    <div id="player-grid" class="player-grid">
        </div>
</div>

<script>
    const SUPABASE_URL = 'https://kouvepburiaqlgmgdwla.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_To3N8ID0x-VKZjlgGon-1A_6wpFLmm4';
    const mySupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentBudget = 0;
    let selectedPlayerIds = [];
    let dynamicPlayers = [];

    // --- 1. CORE MATH LOGIC ---
    function getGain(points, cost) {
        const raw = (points - cost) * 0.1;
        let intermediate = Math.round(raw * 100) / 100; 
        let finalGain = Math.round(intermediate * 10) / 10; 

        // Floor logic: Cost cannot go below 4.0
        if (finalGain < 0 && (cost + finalGain) < 4.0) {
            finalGain = -(cost - 4.0);
        }
        return finalGain;
    }

    // --- 2. LOAD DATA & CALCULATE DYNAMIC VALUES ---
    async function init() {
        const { data: { user } } = await mySupabase.auth.getUser();

        // 1. Fetch Manual Round Number from 'settings' table
        const { data: settings } = await mySupabase
            .from('settings')
            .select('value')
            .eq('key', 'current_round')
            .single();
        
        // This is the round the users are currently drafting for
        const manualRound = settings ? settings.value : 1;

        // 2. Fetch data, but FILTER scores and history by your manual round
        // We only want scores from PREVIOUS rounds to affect current costs
        const { data: players } = await mySupabase.from('players').select('*');
        
        const { data: scores } = await mySupabase.from('player_scores')
            .select('*')
            .lt('round_number', manualRound) // "Less Than" - only rounds already finished
            .order('round_number', { ascending: true });

        const { data: history } = await mySupabase.from('past_teams')
            .select('*')
            .eq('user_id', user.id)
            .lt('round_number', manualRound); // Only historical gains already processed

        const { data: currentTeamRow } = await mySupabase.from('user_teams')
            .select('*')
            .eq('user_id', user.id)
            .single();

        // --- A. Calculate Dynamic Player Costs (Limited by manualRound) ---
        dynamicPlayers = players.map(p => {
            let runningCost = p.cost;
            const playerScores = scores.filter(s => s.player_id === p.id);
            
            playerScores.forEach(s => {
                runningCost += getGain(s.points, runningCost);
            });
            return { ...p, currentCost: runningCost };
        });

        // --- B. Calculate User Budget (Limited by manualRound) ---
        let totalGainFromHistory = 0;
        history.forEach(round => {
            round.player_ids.forEach((pId, index) => {
                const costAtTime = round.player_costs_at_time[index];
                const score = scores.find(s => s.player_id === pId && s.round_number === round.round_number);
                if (score) {
                    totalGainFromHistory += getGain(score.points, costAtTime);
                }
            });
        });

        currentBudget = (currentTeamRow.credits || 70) + totalGainFromHistory;
        selectedPlayerIds = currentTeamRow.player_ids || [];

        renderUI();
    }

    // --- 3. RENDER UI ---
    function renderUI() {
        const grid = document.getElementById('player-grid');
        grid.innerHTML = '';

        // Update Budget Display
        const spent = dynamicPlayers
            .filter(p => selectedPlayerIds.includes(p.id))
            .reduce((sum, p) => sum + p.currentCost, 0);
        
        document.getElementById('credit-display').innerText = (currentBudget - spent).toFixed(1);

        // Render Cards
        dynamicPlayers.forEach(p => {
            const isSelected = selectedPlayerIds.includes(p.id);
            const card = document.createElement('div');
            card.className = `player-card ${isSelected ? 'selected' : ''}`;
            card.innerHTML = `
                <span class="player-name">${p.name}</span>
                <div class="price-tag">${p.currentCost.toFixed(1)} Credits</div>
            `;
            card.onclick = () => togglePlayer(p.id);
            grid.appendChild(card);
        });
    }

    function togglePlayer(id) {
        if (selectedPlayerIds.includes(id)) {
            selectedPlayerIds = selectedPlayerIds.filter(pid => pid !== id);
        } else {
            // Check budget before adding
            const p = dynamicPlayers.find(p => p.id === id);
            const spent = dynamicPlayers.filter(p => selectedPlayerIds.includes(p.id)).reduce((sum, p) => sum + p.currentCost, 0);
            if (spent + p.currentCost > currentBudget) return alert("Not enough credits!");
            
            selectedPlayerIds.push(id);
        }
        renderUI();
    }

    async function saveTeam() {
        const { data: { user } } = await mySupabase.auth.getUser();
        const { error } = await mySupabase
            .from('user_teams')
            .update({ player_ids: selectedPlayerIds })
            .eq('user_id', user.id);

        if (error) alert("Error saving: " + error.message);
        else alert("Team saved successfully!");
    }

    init();
</script>
</body>
</html>